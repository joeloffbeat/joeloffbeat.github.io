import*as s from"https://cdn.skypack.dev/three@0.132.2";import{OrbitControls as z}from"https://cdn.skypack.dev/three@0.132.2/examples/jsm/controls/OrbitControls.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function i(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(n){if(n.ep)return;n.ep=!0;const o=i(n);fetch(n.href,o)}})();const f={AMBIENT_INTENSITY:.6,DIRECTIONAL_INTENSITY:.6,DIRECTIONAL_POSITION:{x:20,y:30,z:10},SHADOW_MAP_SIZE:2048,SHADOW_CAMERA_BOUNDS:{top:50,bottom:-50,left:-50,right:50,near:.1,far:200}},d={ISOMETRIC_DISTANCE:40,VIEW_SIZE:30,NEAR:1,FAR:1e3,INSIDE_POSITION:{x:0,y:25,z:0}},H={BACKGROUND_COLOR:0,INITIAL_BACKGROUND:5999449},I={INITIAL_POSITION:{x:0,y:1,z:11},SCALE:{x:2,y:2,z:1},SPEED:.15,BOBBING:{BASE_HEIGHT:2,SPEED:5,AMOUNT:.01},ANIMATIONS:{idle:{frames:1,duration:8,frameIndices:[1]},walk:{frames:3,duration:8,frameIndices:[0,1,2]}}},x={SIZE:{width:100,height:100}},y={SHADOW_TYPE:"PCFSoftShadowMap",ENABLE_SHADOWS:!0},p={ENABLE_ROTATE:!1,ENABLE_DAMPING:!0,DAMPING_FACTOR:.1,SCREEN_SPACE_PANNING:!1,MOUSE_BUTTONS:{LEFT:null}},b={GRASS_TEXTURE:"../assets/grass.png",CHARACTER_SPRITE:"../assets/character.png"};function G(){const e=new s.Scene;e.background=new s.Color(H.INITIAL_BACKGROUND);const t=new s.AmbientLight(16777215,f.AMBIENT_INTENSITY);e.add(t);const i=new s.DirectionalLight(16777215,f.DIRECTIONAL_INTENSITY);i.position.set(f.DIRECTIONAL_POSITION.x,f.DIRECTIONAL_POSITION.y,f.DIRECTIONAL_POSITION.z),i.castShadow=!0;const r=f.SHADOW_CAMERA_BOUNDS;return i.shadow.camera.top=r.top,i.shadow.camera.bottom=r.bottom,i.shadow.camera.left=r.left,i.shadow.camera.right=r.right,i.shadow.camera.near=r.near,i.shadow.camera.far=r.far,i.shadow.mapSize.width=f.SHADOW_MAP_SIZE,i.shadow.mapSize.height=f.SHADOW_MAP_SIZE,e.add(i),{scene:e,ambientLight:t,directionalLight:i}}function U(){const e=window.innerWidth/window.innerHeight,t=new s.OrthographicCamera(-30*e,d.VIEW_SIZE*e,d.VIEW_SIZE,-30,d.NEAR,d.FAR);return t.position.set(d.ISOMETRIC_DISTANCE,d.ISOMETRIC_DISTANCE,d.ISOMETRIC_DISTANCE),t.lookAt(0,0,0),t}new s.TextureLoader;const F=new s.TextureLoader;let S;const k=3,v=8,w=1/v,O=1/k;function V(){S=F.load(new URL(b.CHARACTER_SPRITE,import.meta.url).href,i=>{i.magFilter=s.NearestFilter},void 0,i=>console.error("Error loading character texture:",i)),S.wrapS=s.RepeatWrapping,S.wrapT=s.RepeatWrapping,S.repeat.set(w,O);const e=new s.SpriteMaterial({map:S,transparent:!0}),t=new s.Sprite(e);return t.castShadow=!0,t.scale.set(I.SCALE.x*2,I.SCALE.y*2,I.SCALE.z*3),t.position.set(I.INITIAL_POSITION.x,I.INITIAL_POSITION.y,I.INITIAL_POSITION.z),t.userData={isMoving:!1,isIdle:!0,direction:"right",directionIndex:0,animations:I.ANIMATIONS,currentAnimation:"idle",frame:1,frameItr:0},e.map.repeat.set(w,O),e.map.offset.set(0,1),t}function W(e){if(!e||e.lengthSq()===0)return 0;let i=(Math.atan2(e.z,e.x)*180/Math.PI+360)%360;return(Math.round(i/45)%8+3)%8}function T(e){e.userData.currentAnimation!=="idle"&&(e.userData.currentAnimation="idle",e.userData.frame=1,e.userData.frameItr=0)}function B(e){e.userData.currentAnimation!=="walk"&&(e.userData.currentAnimation="walk",e.userData.frame=0,e.userData.frameItr=0)}function Z(e){const t=e.userData.animations[e.userData.currentAnimation];if(e.userData.frameItr+=1,e.userData.frameItr>t.duration&&t.frames>1){e.userData.frameItr=0;let a=e.userData.frame;e.userData.frame=t.frameIndices[(a+1)%t.frames]}const i=e.userData.directionIndex||0,r=e.userData.frame||0,n=i*w,o=r*O;e.material.map.offset.set(n,o)}function Y(e,t,i,r=[]){const{keys:n,isMoving:o,targetPosition:a}=t,D=I.SPEED,c=new s.Vector3;let E=!1;const L=I.COLLISION_RADIUS||I.SCALE.x*1.5*.5;function C(h){if(!r||r.length===0)return!1;const l=new s.Sphere(h,L);for(let u=0;u<r.length;u++)if(r[u].intersectsSphere(l))return!0;return!1}function g(h){const l=x.SIZE.width/2,u=x.SIZE.height/2,A=L+.1,R=-l+A,_=l-A,M=-u+A,P=u-A,m=h.clone();return m.x<R&&(m.x=R),m.x>_&&(m.x=_),m.z<M&&(m.z=M),m.z>P&&(m.z=P),m}if(t.isMoving&&t.targetPosition&&(t.targetPosition=g(t.targetPosition)),(n.w||n.ArrowUp)&&(c.x-=1,c.z-=1,E=!0),(n.s||n.ArrowDown)&&(c.x+=1,c.z+=1,E=!0),(n.a||n.ArrowLeft)&&(c.x-=1,c.z+=1,e.userData.direction="left",E=!0),(n.d||n.ArrowRight)&&(c.x+=1,c.z-=1,e.userData.direction="right",E=!0),E&&c.lengthSq()>0){t.isMoving=!1,B(e),c.normalize(),e.userData.directionIndex=W(c),c.multiplyScalar(D);let h=e.position.clone().add(c);h=g(h),C(h)?T(e):e.position.copy(h)}else if(t.isMoving)if(B(e),e.position.distanceTo(a)>.1){const l=new s.Vector3;l.subVectors(a,e.position),l.normalize(),l.multiplyScalar(D);let u=e.position.clone().add(l);u=g(u),C(u)?(t.isMoving=!1,T(e)):e.position.copy(u),e.userData.direction=l.x>0?"right":"left",e.userData.directionIndex=W(l)}else t.isMoving=!1,T(e);else T(e);const N=I.BOBBING;e.position.y=N.BASE_HEIGHT+Math.sin(i.getElapsedTime()*N.SPEED)*N.AMOUNT,Z(e)}const K=new s.TextureLoader;function X(){let e=K.load(new URL(b.GRASS_TEXTURE,import.meta.url).href,a=>{a.magFilter=s.NearestFilter},void 0,a=>console.error("Error loading grass texture:",a));e.wrapS=s.RepeatWrapping,e.wrapT=s.RepeatWrapping,e.repeat.set(15,15);const t=100,i=100,r=new s.PlaneGeometry(t,i),n=new s.MeshStandardMaterial({map:e}),o=new s.Mesh(r,n);return o.rotation.x=-Math.PI/2,o.receiveShadow=!0,o}function q(e,t,i,r){r.addEventListener("mousedown",n=>j(n,e,t,i),!1),r.addEventListener("contextmenu",n=>n.preventDefault(),!1),window.addEventListener("keydown",n=>$(n,i),!1),window.addEventListener("keyup",n=>J(n,i.keys),!1)}function j(e,t,i,r){if(e.button===0){const n=new s.Vector2;n.x=e.clientX/window.innerWidth*2-1,n.y=-(e.clientY/window.innerHeight)*2+1;const o=new s.Raycaster;o.setFromCamera(n,t);const a=o.intersectObject(i);a.length>0&&(r.targetPosition.copy(a[0].point),r.targetPosition.y=1,r.isMoving=!0)}}function $(e,t){e.key in t.keys&&(t.keys[e.key]=!0,t.isMoving=!1)}function J(e,t){e.key in t&&(t[e.key]=!1)}new s.Vector3(d.ISOMETRIC_DISTANCE,d.ISOMETRIC_DISTANCE,d.ISOMETRIC_DISTANCE);new s.Vector3(d.INSIDE_POSITION.x,d.INSIDE_POSITION.y,d.INSIDE_POSITION.z);class Q{constructor(){this.scene=null,this.camera=null,this.renderer=null,this.controls=null,this.clock=new s.Clock,this.character=null,this.ground=null,this.car=null,this.ambientLight=null,this.directionalLight=null,this.controlsState={keys:{w:!1,a:!1,s:!1,d:!1,ArrowUp:!1,ArrowLeft:!1,ArrowDown:!1,ArrowRight:!1},isMoving:!1,targetPosition:new s.Vector3}}init(){this.setupScene(),this.setupCamera(),this.setupRenderer(),this.setupControls(),this.createWorld(),this.setupInputControls(),this.setupLighting(),this.setupEventListeners(),this.animate()}setupScene(){const t=G();this.scene=t.scene,this.ambientLight=t.ambientLight,this.directionalLight=t.directionalLight}setupCamera(){this.camera=U()}setupRenderer(){this.renderer=new s.WebGLRenderer({antialias:!0}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.shadowMap.enabled=y.ENABLE_SHADOWS,this.renderer.shadowMap.type=s[y.SHADOW_TYPE],document.body.appendChild(this.renderer.domElement)}setupControls(){this.controls=new z(this.camera,this.renderer.domElement),this.controls.enableRotate=p.ENABLE_ROTATE,this.controls.enableDamping=p.ENABLE_DAMPING,this.controls.dampingFactor=p.DAMPING_FACTOR,this.controls.screenSpacePanning=p.SCREEN_SPACE_PANNING,this.controls.mouseButtons={LEFT:p.MOUSE_BUTTONS.LEFT,MIDDLE:s.MOUSE.DOLLY,RIGHT:s.MOUSE.PAN}}createWorld(){this.ground=X(),this.scene.add(this.ground),this.scene.add(this.car),this.colliders=[],this.character=V(),this.scene.add(this.character),this.controlsState.targetPosition.copy(this.character.position)}setupInputControls(){q(this.camera,this.ground,this.controlsState,this.renderer.domElement),this.camera,this.controls,this.character}setupLighting(){this.ambientLight.intensity=f.AMBIENT_INTENSITY,this.directionalLight.intensity=f.DIRECTIONAL_INTENSITY,this.scene.background=new s.Color(H.BACKGROUND_COLOR)}setupEventListeners(){window.addEventListener("resize",()=>this.handleResize(),!1)}handleResize(){const t=window.innerWidth/window.innerHeight,i=d.VIEW_SIZE;this.camera.left=-i*t,this.camera.right=i*t,this.camera.top=i,this.camera.bottom=-i,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)}animate(){requestAnimationFrame(()=>this.animate()),this.clock.getDelta(),this.controls.update(),Y(this.character,this.controlsState,this.clock,this.colliders),this.renderer.render(this.scene,this.camera)}}const ee=new Q;ee.init();
